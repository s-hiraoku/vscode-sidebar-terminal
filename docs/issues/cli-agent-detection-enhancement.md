# Issue: CLI Agent検出機能の強化とバグ修正

## 概要
現在、CLI Agent（旧Claude Code）の検出機能がTerminalManager内に実装されており、単一責任原則に違反しています。この機能を適切なクラスに分離し、検出精度を向上させる必要があります。

## 現状の問題点

### 1. アーキテクチャの問題
- **単一責任原則の違反**: TerminalManagerがターミナル管理とCLI Agent検出の両方を担当
- **責務の混在**: 本来独立すべき機能が密結合している
- **テストの困難性**: CLI Agent検出ロジックを単独でテストできない

### 2. 検出機能の問題
- **検出パターンの不足**: 一部のCLI Agent起動パターンを検出できない
- **誤検出**: 類似した文字列で誤って検出される可能性
- **終了検出の不正確さ**: CLI Agentの終了を正確に検出できない場合がある

### 3. 状態管理の問題
- **状態の不整合**: Extension側とWebView側でCLI Agent状態が同期されない場合がある
- **メモリリーク**: ターミナル削除時にCLI Agent関連データが適切にクリーンアップされない

## 解決策

### 1. アーキテクチャの改善
- **新クラスの作成**: `SidebarCliAgentDetector`クラスを作成し、CLI Agent検出ロジックを分離
- **イベント駆動設計**: TerminalManagerとの疎結合を実現
- **責務の明確化**: 各クラスが単一の責務を持つように再設計

### 2. 検出機能の強化
- **検出パターンの拡充**: より多様なCLI Agent起動パターンに対応
- **コンテキスト認識**: 前後の出力を考慮した検出アルゴリズム
- **設定可能な検出**: ユーザーがカスタム検出パターンを追加可能

### 3. 状態管理の改善
- **統一された状態管理**: Single Source of Truthの実現
- **自動クリーンアップ**: ターミナル削除時の確実なリソース解放
- **リアルタイム同期**: Extension-WebView間の即座の状態同期

## 実装計画

### フェーズ1: 分離と移行
1. `SidebarCliAgentDetector`クラスの作成
2. TerminalManagerからCLI Agent関連コードを移動
3. イベントベースの連携実装

### フェーズ2: 機能強化
1. 検出パターンの改善と拡充
2. 誤検出防止メカニズムの実装
3. 終了検出の精度向上

### フェーズ3: 統合とテスト
1. 既存コードとの統合
2. 包括的なユニットテストの作成
3. エンドツーエンドテストの実装

## 期待される効果

1. **保守性の向上**: 責務が明確化され、コードの理解と修正が容易に
2. **拡張性の向上**: 新しい検出パターンや機能の追加が簡単に
3. **信頼性の向上**: より正確なCLI Agent検出と状態管理
4. **パフォーマンスの向上**: 効率的な検出アルゴリズムによる処理速度向上

## 関連ファイル

- `/src/terminals/TerminalManager.ts` - リファクタリング対象
- `/src/integration/SidebarCliAgentDetector.ts` - 新規作成
- `/src/integration/CliAgentTerminalTracker.ts` - 既存のトラッカー（VS Code標準ターミナル用）
- `/src/providers/SecondaryTerminalProvider.ts` - 統合ポイント

## テスト項目

1. CLI Agent起動の正確な検出
2. CLI Agent終了の正確な検出
3. 複数ターミナルでの独立した検出
4. メモリリークの防止
5. Extension-WebView間の状態同期

## 備考

この改善により、CLI Agent統合機能の信頼性と保守性が大幅に向上し、今後の機能拡張にも柔軟に対応できるようになります。