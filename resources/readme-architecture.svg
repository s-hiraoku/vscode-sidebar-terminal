<?xml version="1.0" encoding="UTF-8"?>
<svg width="1280" height="520" viewBox="0 0 1280 520" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="title desc">
  <title id="title">Secondary Terminal architecture</title>
  <desc id="desc">Diagram showing the VS Code UI and webview (xterm.js) connected to the extension host and node-pty, with session persistence and CLI agent detection.</desc>
  <defs>
    <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#0b1220"/>
      <stop offset="100%" stop-color="#111827"/>
    </linearGradient>
    <linearGradient id="accent" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#60a5fa"/>
      <stop offset="50%" stop-color="#22c55e"/>
      <stop offset="100%" stop-color="#a78bfa"/>
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="10" stdDeviation="12" flood-color="#000000" flood-opacity="0.35"/>
    </filter>
    <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#94a3b8"/>
    </marker>
  </defs>

  <rect width="1280" height="520" fill="url(#bg)"/>

  <text x="64" y="78" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="34" font-weight="800" fill="#ffffff">
    Architecture
  </text>
  <rect x="64" y="92" width="168" height="5" rx="3" fill="url(#accent)"/>
  <text x="64" y="132" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="16" fill="#cbd5e1">
    Webview renders xterm.js; the extension host runs node-pty and manages persistence + integrations.
  </text>

  <!-- Nodes -->
  <g filter="url(#shadow)">
    <!-- VS Code UI -->
    <rect x="64" y="190" width="260" height="120" rx="16" fill="#0f172a" stroke="#243047" stroke-width="1.5"/>
    <text x="92" y="228" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="18" font-weight="700" fill="#e2e8f0">VS Code UI</text>
    <text x="92" y="258" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">
      Activity Bar (ST)
    </text>
    <text x="92" y="282" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">
      Commands + Keybindings
    </text>

    <!-- Webview -->
    <rect x="372" y="170" width="330" height="160" rx="16" fill="#0f172a" stroke="#243047" stroke-width="1.5"/>
    <text x="400" y="208" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="18" font-weight="700" fill="#e2e8f0">Secondary Terminal Webview</text>
    <text x="400" y="238" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">xterm.js rendering + input</text>
    <text x="400" y="262" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">Tabs, split, scroll indicator</text>
    <text x="400" y="286" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">Agent output detection</text>

    <!-- Extension host -->
    <rect x="750" y="170" width="350" height="160" rx="16" fill="#0f172a" stroke="#243047" stroke-width="1.5"/>
    <text x="778" y="208" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="18" font-weight="700" fill="#e2e8f0">Extension Host</text>
    <text x="778" y="238" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">Terminal lifecycle + profiles</text>
    <text x="778" y="262" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">node-pty I/O bridge</text>
    <text x="778" y="286" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">Session persistence</text>

    <!-- Shell / CLI agents -->
    <rect x="1140" y="190" width="156" height="120" rx="16" fill="#0f172a" stroke="#243047" stroke-width="1.5"/>
    <text x="1164" y="228" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="18" font-weight="700" fill="#e2e8f0">Shell</text>
    <text x="1164" y="258" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">bash/zsh/pwsh</text>
    <text x="1164" y="282" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="14" fill="#94a3b8">claude/codex/gemini</text>

    <!-- Persistence store -->
    <rect x="750" y="360" width="350" height="110" rx="16" fill="#0b1020" stroke="#243047" stroke-width="1.5"/>
    <text x="778" y="398" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="16" font-weight="700" fill="#e2e8f0">Persistence</text>
    <text x="778" y="426" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="13" fill="#94a3b8">Scrollback + metadata (ANSI preserved)</text>
    <text x="778" y="448" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="13" fill="#94a3b8">Restore after VS Code restart</text>
  </g>

  <!-- Edges -->
  <g stroke="#94a3b8" stroke-width="2" fill="none" marker-end="url(#arrow)" opacity="0.95">
    <path d="M 324 250 C 350 250, 350 250, 372 250"/>
    <path d="M 702 250 C 726 250, 726 250, 750 250"/>
    <path d="M 1100 250 C 1120 250, 1120 250, 1140 250"/>
  </g>

  <!-- Bidirectional webview/host message bus -->
  <g opacity="0.9">
    <path d="M 702 284 C 726 284, 726 284, 750 284" stroke="#60a5fa" stroke-width="2.5" fill="none" marker-end="url(#arrow)"/>
    <path d="M 750 214 C 726 214, 726 214, 702 214" stroke="#60a5fa" stroke-width="2.5" fill="none" marker-end="url(#arrow)"/>
    <text x="724" y="170" text-anchor="middle" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="12" fill="#93c5fd">
      postMessage
    </text>
  </g>

  <!-- Host to persistence store -->
  <g stroke="#22c55e" stroke-width="2.5" fill="none" marker-end="url(#arrow)" opacity="0.95">
    <path d="M 925 330 C 925 342, 925 342, 925 360"/>
  </g>

  <!-- Legend -->
  <g transform="translate(64 430)">
    <rect x="0" y="0" width="560" height="60" rx="14" fill="#0b1020" stroke="#243047"/>
    <circle cx="18" cy="30" r="5" fill="#60a5fa"/>
    <text x="34" y="35" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="13" fill="#cbd5e1">
      Blue: Webview â‡„ Extension messaging
    </text>
    <circle cx="306" cy="30" r="5" fill="#22c55e"/>
    <text x="322" y="35" font-family="Segoe UI, -apple-system, BlinkMacSystemFont, Arial, sans-serif" font-size="13" fill="#cbd5e1">
      Green: Persistence pipeline
    </text>
  </g>
</svg>
