name: Visual Regression Tests

on:
  pull_request:
    paths:
      - 'src/webview/**'
      - 'src/test/e2e/**'
      - 'playwright.config.ts'
      - 'package.json'
  push:
    branches: [main]
    paths:
      - 'src/webview/**'
      - 'src/test/e2e/**'
      - 'playwright.config.ts'
  workflow_dispatch:
    inputs:
      update_baselines:
        description: 'Update baseline screenshots'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: vrt-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  vrt:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'npm'

      - name: Configure npm settings
        run: |
          npm config set fetch-timeout 600000
          npm config set fetch-retry-mintimeout 60000
          npm config set fetch-retry-maxtimeout 120000
          npm config set progress false

      - name: Install dependencies (non-Windows)
        if: runner.os != 'Windows'
        run: npm ci --prefer-offline --no-audit

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          npm ci --prefer-offline --no-audit --ignore-scripts
          New-Item -ItemType Directory -Force -Path "node_modules\node-pty"
          Set-Content -Path "node_modules\node-pty\package.json" -Value '{"name":"node-pty","version":"1.0.0","main":"index.js"}'
          Set-Content -Path "node_modules\node-pty\index.js" -Value 'module.exports = { spawn: () => ({ pid: 1234, onData: () => {}, onExit: () => {}, write: () => {}, resize: () => {}, kill: () => {} }) };'
        shell: pwsh
        env:
          NODE_PTY_SKIP_DOWNLOAD_BINARY: 1

      - name: Install Playwright Browsers
        run: npx playwright install chromium

      - name: Run VRT Tests
        if: ${{ github.event.inputs.update_baselines != 'true' }}
        run: npm run test:vrt
        timeout-minutes: 10

      - name: Update VRT Baselines
        if: ${{ github.event.inputs.update_baselines == 'true' }}
        run: npm run test:vrt:update
        timeout-minutes: 10

      - name: Upload VRT Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: vrt-report-${{ matrix.os }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: Upload Baseline Screenshots
        if: ${{ github.event.inputs.update_baselines == 'true' }}
        uses: actions/upload-artifact@v6
        with:
          name: vrt-baselines-${{ matrix.os }}
          path: src/test/e2e/__screenshots__/
          retention-days: 30

      - name: Commit Updated Baselines
        if: ${{ github.event.inputs.update_baselines == 'true' }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/test/e2e/__screenshots__/
          git diff --staged --quiet || git commit -m "chore(vrt): update ${{ runner.os }} baselines

          ðŸ¤– Generated with GitHub Actions
          Platform: ${{ matrix.os }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_id }}"

      - name: Push Updated Baselines
        if: ${{ github.event.inputs.update_baselines == 'true' }}
        run: |
          # Pull with rebase to handle parallel matrix job commits
          git pull --rebase origin ${{ github.ref_name }} || true
          git push

      - name: Upload Diff Screenshots on Failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: vrt-diffs-${{ matrix.os }}
          path: |
            test-results/**/*-diff.png
            test-results/**/*-actual.png
            test-results/**/*-expected.png
          retention-days: 7

  # Summary job that runs after all matrix jobs complete
  vrt-summary:
    needs: vrt
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check VRT Results
        run: |
          if [ "${{ needs.vrt.result }}" == "failure" ]; then
            echo "::error::Visual regression tests failed. Check the uploaded artifacts for diff images."
            exit 1
          elif [ "${{ needs.vrt.result }}" == "success" ]; then
            echo "::notice::All visual regression tests passed!"
          else
            echo "::warning::VRT job status: ${{ needs.vrt.result }}"
          fi
