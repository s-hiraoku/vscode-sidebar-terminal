# Integration CLAUDE.md - CLI Agent統合実装ガイド

このファイルはCLI Agent統合機能の効率的な実装をサポートします。

## 核心アーキテクチャ

### CLI Agent統合システム全体図
```
VS Code Extension
├── CliAgentDetectionService - AI検出・分類
├── CliAgentStateService - 状態管理・追跡  
├── CliAgentTerminalTracker - ターミナル連携
└── FileReferenceCommand - ファイル参照統合
```

### 対応CLI Agentの全体
- **Claude Code** (`claude-code "command"`)
- **Gemini Code** (`gemini code "command"`)
- **GitHub Copilot Chat** (`#file:` 参照統合)

## 設計思想・実装パターン

### CLI Agent検出の設計原則
**パターンベース検出システム**
- 正規表現パターンによる多層検出
- 信頼度スコアによる検出精度向上
- 高頻度出力検出による活動状態判定
- ANSI色コード除去等の出力正規化

**検出すべき主要パターン**
- コマンド実行パターン (`agent-name "command"`)
- インタラクティブプロンプト (`Agent:` 等)
- 結果出力パターン (`[Agent Name]` 等)
- URL・ドメイン固有パターン

### 状態管理アーキテクチャ
**階層化状態管理**
- **ターミナル個別状態**: 各ターミナルのCLI Agent活動
- **グローバル状態**: 全体のCLI Agent活動状況
- **時系列状態**: 活動開始・終了時刻の追跡

**状態遷移の考え方**
- 検出 → アクティブ状態 → 非活動タイムアウト → 非アクティブ
- 状態変更時の通知システム（WebView、他コンポーネント）
- 複数CLI Agent同時活動の管理

## パフォーマンス最適化戦略

### CLI Agent専用バッファリング思想
**適応的バッファリング**
- 通常出力: 16ms間隔フラッシュ（60fps）
- CLI Agent活動時: 4ms間隔フラッシュ（250fps）
- 大量出力時: 即座フラッシュ（1000文字以上）
- 動的間隔調整: 出力頻度に応じた自動調整

**バッファ管理戦略**
- ターミナル別バッファ管理
- メモリ効率化（古いデータ自動削除）
- バックプレッシャー制御（過負荷時の処理制限）

### Alt+Click智能制御設計
**衝突回避システム**
- CLI Agent活動検出時の自動無効化（5秒間）
- 高頻度出力検出時の一時無効化
- 視覚フィードバック（ツールチップ表示）
- 自動再有効化通知

**VS Code標準との整合性**
- `terminal.integrated.altClickMovesCursor` 設定準拠
- `editor.multiCursorModifier` 設定準拠
- VS Code標準Alt+Click動作の完全互換性

## ファイル参照統合の設計

### 統一ファイル参照システム
**2つの参照形式統合**
- Claude Code形式: `@filename` または `@filename#L1-L10`
- GitHub Copilot形式: `#file:filename`

**実装における考慮点**
- アクティブエディターからの相対パス取得
- 選択範囲の行番号変換（0ベース→1ベース）
- 複数ターミナルへの並列送信
- エラーケースのユーザーフィードバック

### キーバインド設計思想
**効率的なワークフロー**
- Claude Code: `CMD+Option+L` → 直接ターミナル送信
- Copilot: `CMD+K CMD+C` → Copilotチャット起動+クリップボード
- ファイル参照後のフォーカス管理（サイドバーターミナル）

## 実装時の重要な考慮点

### パフォーマンス監視・最適化
**動的調整システム**
- 出力レイテンシ監視（50ms閾値）
- バッファリング効率の動的調整
- メモリ使用量追跡
- CPU使用率考慮

**最適化戦略**
- 検出パターンの効率化
- 出力正規化処理の最適化
- イベントリスナー管理
- リソース解放の徹底

### エラーハンドリング設計
**堅牢性確保**
- CLI Agent検出失敗の優雅な処理
- ネットワーク関連エラー対応
- ファイル参照失敗時のフォールバック
- ユーザーへの適切なフィードバック

### セキュリティ考慮
**安全な統合**
- 入力値検証（ファイルパス、コマンド）
- 権限確認（ファイルアクセス等）
- CLI Agent出力のサニタイゼーション
- 機密情報漏洩防止

## テスト戦略

### 包括的テストアプローチ
**検出精度テスト**
- 各CLI Agentの検出パターン網羅
- 偽陽性・偽陰性のケース確認
- 信頼度スコアの妥当性検証

**統合テスト**
- Alt+Click衝突回避の動作確認
- ファイル参照統合の正確性確認
- パフォーマンス劣化の検出

**エッジケーステスト**
- 高負荷状況での動作確認
- 複数CLI Agent同時活動
- ネットワーク切断時の動作

## 実装チェックリスト

### CLI Agent統合実装時
- [ ] 検出パターンの設計・実装
- [ ] 階層化状態管理システム構築
- [ ] 適応的バッファリング実装
- [ ] Alt+Click衝突回避機能
- [ ] 統一ファイル参照システム
- [ ] 視覚フィードバックシステム
- [ ] エラーハンドリング・復旧機能
- [ ] パフォーマンス監視・最適化
- [ ] セキュリティ検証
- [ ] 包括的テストスイート

### 品質保証時
- [ ] CLI Agent検出精度確認
- [ ] レスポンス性能確認（50ms以内）
- [ ] メモリ効率確認
- [ ] Alt+Click応答性確認
- [ ] ファイル参照正確性確認
- [ ] エラー耐性確認
- [ ] セキュリティ検証

このガイドでCLI Agent統合の効率的で堅牢な実装が可能です。