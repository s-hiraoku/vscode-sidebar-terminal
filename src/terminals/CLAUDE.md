# Terminals CLAUDE.md - ターミナル管理実装ガイド

このファイルは TerminalManager の効率的な実装をサポートします。

## 核心アーキテクチャ

### TerminalManager - 中央制御システム

**シングルトン管理** - 全ターミナルプロセスの生命周期を制御

- node-pty プロセス管理
- ターミナルID recycling (1-5番)
- アクティブターミナル追跡
- 削除操作の原子性保証

### 重要な設計パターン

#### ターミナル生命周期管理の設計思想

**原子性保証システム**

- 作成・削除操作の原子性保証
- 無限ループ防止機構（削除中状態追跡）
- リソースリーク防止（finally句でのクリーンアップ）
- プロセス終了確認機構

**状態管理の考え方**

- ターミナル状態の一元管理
- アクティブ・非アクティブ状態追跡
- プロセスハンドル生命周期管理

#### ターミナル番号管理アーキテクチャ

**ID再利用システム**

- 1-5番の固定範囲管理（VS Code制限対応）
- 削除後の番号即座再利用
- 最大数制限による安定性確保

**番号割り当て戦略**

- 最小空き番号優先割り当て
- 使用済み番号セット管理
- エラー時の適切な例外処理

## 設計思想・実装パターン

### データ処理最適化アーキテクチャ

**適応的バッファリング戦略**

- 通常出力: 16ms間隔（60fps）
- CLI Agent検出時: 4ms間隔（250fps）
- 動的フラッシュ調整: 出力頻度に応じた最適化

**パフォーマンス考慮点**

- バッファサイズ動的調整
- メモリ効率重視の実装
- CPU使用率監視と調整

### リサイズ処理設計

**デバウンス処理思想**

- 連続リサイズイベントの効率処理
- ターミナル個別タイマー管理
- プロセス負荷軽減策

**レスポンシブ設計**

- WebView サイズ変更への即応
- 複数ターミナル同時リサイズ対応
- エラー耐性のあるサイズ調整

### エラーハンドリング設計思想

**多層防御システム**

- プロセスレベルエラー検出
- リソースクリーンアップ保証
- 自動復旧機能（必要時）
- ユーザーフィードバック統合

**エラー分類と対応**

- 一時的エラー: 再試行機構
- 致命的エラー: 安全な終了処理
- 不明エラー: ログ記録とフォールバック

## パフォーマンス最適化戦略

### CLI Agent検出・対応システム

**検出パターン設計**

- 正規表現ベース多層検出
- コマンド実行パターン認識
- 出力頻度による活動判定
- ANSI色コード対応正規化

**適応的処理調整**

- CLI Agent活動時の高速化
- 通常時の効率バランス
- 動的パラメータ調整
- リソース使用量監視

### メモリ効率化アーキテクチャ

**定期的クリーンアップ戦略**

- 30秒間隔の自動リソース整理
- デッドプロセス検出・除去
- 期限切れバッファクリア
- イベントハンドラー最適化

**メモリリーク防止**

- 循環参照回避設計
- 適切なリソース解放
- WeakMap/WeakSet活用
- ガベージコレクション配慮

## Alt+Click 統合アーキテクチャ

### VS Code標準Alt+Click設計思想

**設定統合システム**

- VS Code標準設定準拠
- 複数設定条件の論理結合
- 動的設定変更対応
- WebView への設定同期

**互換性確保**

- `terminal.integrated.altClickMovesCursor`準拠
- `editor.multiCursorModifier`連携
- VS Code標準動作との完全互換
- 設定変更時の即座反映

## トラブルシューティング戦略

### 一般的な問題パターンと診断手法

**ターミナル作成失敗**

- node-ptyバイナリ互換性確認
- シェル実行権限確認
- 作業ディレクトリ存在確認
- プラットフォーム固有問題調査

**メモリリーク診断**

- アクティブターミナル数監視
- イベントリスナー数追跡
- プロセスハンドル数確認
- ガベージコレクション強制実行

**パフォーマンス劣化診断**

- バッファサイズ状況確認
- フラッシュ頻度測定
- CPU使用率監視
- メモリ使用量トレンド分析

## テスト戦略設計

### 単体テスト重要ポイント

**無限ループ防止テスト**

- 同時削除操作の原子性確認
- 競合状態の適切な処理
- リソース解放の完全性確認
- エラー状態からの復旧確認

**テスト項目設計**

- プロセス生命周期管理
- 番号リサイクリング機能
- エラーハンドリング堅牢性
- パフォーマンス劣化検出

## 実装チェックリスト

### 新機能追加時

- [ ] node-pty プロセス制御
- [ ] ターミナル番号管理 (1-5)
- [ ] 無限ループ防止
- [ ] メモリリーク対策
- [ ] CLI Agent対応
- [ ] Alt+Click統合
- [ ] エラーハンドリング
- [ ] テストケース作成

### パフォーマンス確認

- [ ] データフラッシュ頻度
- [ ] バッファサイズ適正化
- [ ] イベントリスナー整理
- [ ] プロセス終了確認
- [ ] メモリ使用量確認

このガイドでターミナル管理の効率的な実装が可能です。
